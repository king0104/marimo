import 'dart:convert';
import 'package:shared_preferences/shared_preferences.dart';

const List<Map<String, dynamic>> rawObdSample = [
  {"code": "NO RESPONSE", "pid": "00"},
  {"code": "STOPPED", "pid": "01"},
  {"code": "SEARCHING...\nNO DATA", "pid": "02"},
  {"code": "7E80441030200", "pid": "03"},
  {"code": "7E903410421\n7E803410421", "pid": "04"},
  {"code": "7E903410577", "pid": "05"},
  {"code": "7E803410684", "pid": "06"},
  {"code": "7E803410779", "pid": "07"},
  {"code": "NO DATA", "pid": "08"},
  {"code": "NO DATA", "pid": "09"},
  {"code": "NO DATA", "pid": "0A"},
  {"code": "7E803410B24", "pid": "0B"},
  {"code": "7E804410C0B86\n7EE04410C0B86\n7E904410C0B86", "pid": "0C"},
  {"code": "7E803410D00\n7E903410D00", "pid": "0D"},
  {"code": "7E803410E7B", "pid": "0E"},
  {"code": "7E803410F3E", "pid": "0F"},
  {"code": "7E804411000D3", "pid": "10"},
  {"code": "7E903411120\n7E803411120", "pid": "11"},
  {"code": "NO DATA", "pid": "12"},
  {"code": "7E803411303", "pid": "13"},
  {"code": "NO DATA", "pid": "14"},
  {"code": "7E804411550FF", "pid": "15"},
  {"code": "NO DATA", "pid": "16"},
  {"code": "NO DATA", "pid": "17"},
  {"code": "NO DATA", "pid": "18"},
  {"code": "NO DATA", "pid": "19"},
  {"code": "NO DATA", "pid": "1A"},
  {"code": "NO DATA", "pid": "1B"},
  {"code": "7E903411C03\n7E803411C1E", "pid": "1C"},
  {"code": "NO DATA", "pid": "1D"},
  {"code": "NO DATA", "pid": "1E"},
  {"code": "7E904411F0227\n7E804411F0227", "pid": "1F"},
  {
    "code": "7EE06412000018001\n7E906412080018001\n7E8064120A01FF011",
    "pid": "20",
  },
  {"code": "7E90441210000\n7E80441210000", "pid": "21"},
  {"code": "NO DATA", "pid": "22"},
  {"code": "7E80441230310", "pid": "23"},
  {"code": "NO DATA", "pid": "24"},
  {"code": "NO DATA", "pid": "25"},
  {"code": "NO DATA", "pid": "26"},
  {"code": "NO DATA", "pid": "27"},
  {"code": "NO DATA", "pid": "28"},
  {"code": "NO DATA", "pid": "29"},
  {"code": "NO DATA", "pid": "2A"},
  {"code": "NO DATA", "pid": "2B"},
  {"code": "7E803412C00", "pid": "2C"},
  {"code": "7E803412D80", "pid": "2D"},
  {"code": "7E803412E48", "pid": "2E"},
  {"code": "7E803412F44", "pid": "2F"},
  {"code": "7EE034130F1\n7E9034130F1\n7E8034130F1", "pid": "30"},
  {"code": "7E904413135B4\n7EE044131365C\n7E804413136F8", "pid": "31"},
  {"code": "7E8044132F922", "pid": "32"},
  {"code": "7E803413363", "pid": "33"},
  {"code": "7E80641347FF77FFB", "pid": "34"},
  {"code": "NO DATA", "pid": "35"},
  {"code": "NO DATA", "pid": "36"},
  {"code": "NO DATA", "pid": "37"},
  {"code": "NO DATA", "pid": "38"},
  {"code": "NO DATA", "pid": "39"},
  {"code": "NO DATA", "pid": "3A"},
  {"code": "NO DATA", "pid": "3B"},
  {"code": "7E804413C0DC3", "pid": "3C"},
  {"code": "NO DATA", "pid": "3D"},
  {"code": "NO DATA", "pid": "3E"},
  {"code": "NO DATA", "pid": "3F"},
  {
    "code": "7EE06414080000000\n7E9064140C0800000\n7E8064140FED08C01",
    "pid": "40",
  },
  {
    "code": "7EE06414100040000\n7E906414100040000\n7E80641410007E5A5",
    "pid": "41",
  },
  {"code": "7E9044142391D\n7E804414239AD", "pid": "42"},
  {"code": "7E8044143003D", "pid": "43"},
  {"code": "7E80441447FFF", "pid": "44"},
  {"code": "7E803414506", "pid": "45"},
  {"code": "7E80341463D", "pid": "46"},
  {"code": "7E80341471F", "pid": "47"},
  {"code": "NO DATA", "pid": "48"},
  {"code": "7E903414900\n7E803414925", "pid": "49"},
  {"code": "7E803414A12", "pid": "4A"},
  {"code": "NO DATA", "pid": "4B"},
  {"code": "7E803414C09", "pid": "4C"},
  {"code": "NO DATA", "pid": "4D"},
  {"code": "NO DATA", "pid": "4E"},
  {"code": "NO DATA", "pid": "4F"},
  {"code": "NO DATA", "pid": "50"},
  {"code": "7E803415101", "pid": "51"},
  {"code": "NO DATA", "pid": "52"},
  {"code": "NO DATA", "pid": "53"},
  {"code": "NO DATA", "pid": "54"},
  {"code": "7E803415580", "pid": "55"},
  {"code": "7E803415680", "pid": "56"},
  {"code": "NO DATA", "pid": "57"},
  {"code": "NO DATA", "pid": "58"},
  {"code": "NO DATA", "pid": "59"},
  {"code": "NO DATA", "pid": "5A"},
  {"code": "NO DATA", "pid": "5B"},
  {"code": "NO DATA", "pid": "5C"},
  {"code": "NO DATA", "pid": "5D"},
  {"code": "NO DATA", "pid": "5E"},
  {"code": "NO DATA", "pid": "5F"},
  {"code": "7E806416062200001", "pid": "60"},
  {"code": "NO DATA", "pid": "61"},
  {"code": "7E803416282", "pid": "62"},
  {"code": "7E8044163015E", "pid": "63"},
  {"code": "NO DATA", "pid": "64"},
  {"code": "NO DATA", "pid": "65"},
  {"code": "NO DATA", "pid": "66"},
  {"code": "7E8054167036A5B", "pid": "67"},
  {"code": "NO DATA", "pid": "68"},
  {"code": "NO DATA", "pid": "69"},
  {"code": "NO DATA", "pid": "6A"},
  {"code": "7E807416B1014000000", "pid": "6B"},
  {"code": "NO DATA", "pid": "6C"},
  {"code": "NO DATA", "pid": "6D"},
  {"code": "NO DATA", "pid": "6E"},
  {"code": "NO DATA", "pid": "6F"},
  {"code": "NO DATA", "pid": "70"},
  {"code": "NO DATA", "pid": "71"},
  {"code": "NO DATA", "pid": "72"},
  {"code": "NO DATA", "pid": "73"},
  {"code": "NO DATA", "pid": "74"},
  {"code": "NO DATA", "pid": "75"},
  {"code": "NO DATA", "pid": "76"},
  {"code": "NO DATA", "pid": "77"},
  {"code": "NO DATA", "pid": "78"},
  {"code": "NO DATA", "pid": "79"},
  {"code": "NO DATA", "pid": "7A"},
  {"code": "NO DATA", "pid": "7B"},
  {"code": "NO DATA", "pid": "7C"},
  {"code": "NO DATA", "pid": "7D"},
  {"code": "NO DATA", "pid": "7E"},
  {"code": "NO DATA", "pid": "7F"},
  {"code": "7E80641800004000D", "pid": "80"},
  {"code": "NO DATA", "pid": "81"},
  {"code": "NO DATA", "pid": "82"},
  {"code": "NO DATA", "pid": "83"},
  {"code": "NO DATA", "pid": "84"},
  {"code": "NO DATA", "pid": "85"},
  {"code": "NO DATA", "pid": "86"},
  {"code": "NO DATA", "pid": "87"},
  {"code": "NO DATA", "pid": "88"},
  {"code": "NO DATA", "pid": "89"},
  {"code": "NO DATA", "pid": "8A"},
  {"code": "NO DATA", "pid": "8B"},
  {"code": "NO DATA", "pid": "8C"},
  {"code": "NO DATA", "pid": "8D"},
  {"code": "7E803418E81", "pid": "8E"},
  {"code": "NO DATA", "pid": "8F"},
  {"code": "NO DATA", "pid": "90"},
  {"code": "NO DATA", "pid": "91"},
  {"code": "NO DATA", "pid": "92"},
  {"code": "NO DATA", "pid": "93"},
  {"code": "NO DATA", "pid": "94"},
  {"code": "NO DATA", "pid": "95"},
  {"code": "NO DATA", "pid": "96"},
  {"code": "NO DATA", "pid": "97"},
  {"code": "NO DATA", "pid": "98"},
  {"code": "NO DATA", "pid": "99"},
  {"code": "NO DATA", "pid": "9A"},
  {"code": "NO DATA", "pid": "9B"},
  {"code": "NO DATA", "pid": "9C"},
  {"code": "7E806419D00070007", "pid": "9D"},
  {"code": "7E804419E0033", "pid": "9E"},
  {"code": "NO DATA", "pid": "9F"},
  {"code": "7E80641A004000000", "pid": "A0"},
  {"code": "NO DATA", "pid": "A1"},
  {"code": "NO DATA", "pid": "A2"},
  {"code": "NO DATA", "pid": "A3"},
  {"code": "NO DATA", "pid": "A4"},
  {"code": "NO DATA", "pid": "A5"},
  {"code": "7E80641A600022B79", "pid": "A6"},
  {"code": "NO DATA", "pid": "A7"},
  {"code": "NO DATA", "pid": "A8"},
  {"code": "NO DATA", "pid": "A9"},
  {"code": "NO DATA", "pid": "AA"},
  {"code": "NO DATA", "pid": "AB"},
  {"code": "NO DATA", "pid": "AC"},
  {"code": "NO DATA", "pid": "AD"},
  {"code": "NO DATA", "pid": "AE"},
  {"code": "NO DATA", "pid": "AF"},
  {"code": "NO DATA", "pid": "B0"},
  {"code": "NO DATA", "pid": "B1"},
  {"code": "NO DATA", "pid": "B2"},
  {"code": "NO DATA", "pid": "B3"},
  {"code": "NO DATA", "pid": "B4"},
  {"code": "NO DATA", "pid": "B5"},
  {"code": "NO DATA", "pid": "B6"},
  {"code": "NO DATA", "pid": "B7"},
  {"code": "NO DATA", "pid": "B8"},
  {"code": "NO DATA", "pid": "B9"},
  {"code": "NO DATA", "pid": "BA"},
  {"code": "NO DATA", "pid": "BB"},
  {"code": "NO DATA", "pid": "BC"},
  {"code": "NO DATA", "pid": "BD"},
  {"code": "NO DATA", "pid": "BE"},
  {"code": "NO DATA", "pid": "BF"},
  {"code": "NO DATA", "pid": "C0"},
  {"code": "NO DATA", "pid": "C1"},
  {"code": "NO DATA", "pid": "C2"},
  {"code": "NO DATA", "pid": "C3"},
  {"code": "NO DATA", "pid": "C4"},
  {"code": "NO DATA", "pid": "C5"},
  {"code": "NO DATA", "pid": "C6"},
  {"code": "NO DATA", "pid": "C7"},
  {"code": "NO DATA", "pid": "C8"},
  {"code": "NO DATA", "pid": "C9"},
  {"code": "NO DATA", "pid": "CA"},
  {"code": "NO DATA", "pid": "CB"},
  {"code": "NO DATA", "pid": "CC"},
  {"code": "NO DATA", "pid": "CD"},
  {"code": "NO DATA", "pid": "CE"},
  {"code": "NO DATA", "pid": "CF"},
  {"code": "NO DATA", "pid": "D0"},
  {"code": "NO DATA", "pid": "D1"},
  {"code": "NO DATA", "pid": "D2"},
  {"code": "NO DATA", "pid": "D3"},
  {"code": "NO DATA", "pid": "D4"},
  {"code": "NO DATA", "pid": "D5"},
  {"code": "NO DATA", "pid": "D6"},
  {"code": "NO DATA", "pid": "D7"},
  {"code": "NO DATA", "pid": "D8"},
  {"code": "NO DATA", "pid": "D9"},
  {"code": "NO DATA", "pid": "DA"},
  {"code": "NO DATA", "pid": "DB"},
  {"code": "NO DATA", "pid": "DC"},
  {"code": "NO DATA", "pid": "DD"},
  {"code": "NO DATA", "pid": "DE"},
  {"code": "NO DATA", "pid": "DF"},
  {"code": "NO DATA", "pid": "E0"},
  {"code": "NO DATA", "pid": "E1"},
  {"code": "NO DATA", "pid": "E2"},
  {"code": "NO DATA", "pid": "E3"},
  {"code": "NO DATA", "pid": "E4"},
  {"code": "NO DATA", "pid": "E5"},
  {"code": "NO DATA", "pid": "E6"},
  {"code": "NO DATA", "pid": "E7"},
  {"code": "NO DATA", "pid": "E8"},
  {"code": "NO DATA", "pid": "E9"},
  {"code": "NO DATA", "pid": "EA"},
  {"code": "NO DATA", "pid": "EB"},
  {"code": "NO DATA", "pid": "EC"},
  {"code": "NO DATA", "pid": "ED"},
  {"code": "NO DATA", "pid": "EE"},
  {"code": "NO DATA", "pid": "EF"},
  {"code": "NO DATA", "pid": "F0"},
  {"code": "NO DATA", "pid": "F1"},
  {"code": "NO DATA", "pid": "F2"},
  {"code": "NO DATA", "pid": "F3"},
  {"code": "NO DATA", "pid": "F4"},
  {"code": "NO DATA", "pid": "F5"},
  {"code": "NO DATA", "pid": "F6"},
  {"code": "NO DATA", "pid": "F7"},
  {"code": "NO DATA", "pid": "F8"},
  {"code": "NO DATA", "pid": "F9"},
  {"code": "NO DATA", "pid": "FA"},
  {"code": "NO DATA", "pid": "FB"},
  {"code": "NO DATA", "pid": "FC"},
  {"code": "NO DATA", "pid": "FD"},
  {"code": "NO DATA", "pid": "FE"},
  {"code": "NO DATA\n", "pid": "FF"},
  {"code": "7E80441030000", "pid": "0103"},
  {"code": "7E803410400", "pid": "0104"},
  {"code": "7E803410547", "pid": "0105"},
  {"code": "7E803410680", "pid": "0106"},
  {"code": "7E803410780", "pid": "0107"},
  {"code": "7E803410B63", "pid": "010B"},
  {"code": "7E904410C0000\r7E804410C0000", "pid": "010C"},
  {"code": "7E803410D00", "pid": "010D"},
  {"code": "7E803410E84", "pid": "010E"},
  {"code": "NO DATA", "pid": "010F"},
  {"code": "7E80441100000", "pid": "0110"},
  {"code": "7E803411120", "pid": "0111"},
  {"code": "7E803411303", "pid": "0113"},
  {"code": "7E804411512FF", "pid": "0115"},
  {"code": "7E803411C1E", "pid": "011C"},
  {"code": "7E804411F021A", "pid": "011F"},
  {
    "code":
        "7E8064120A01FF011\r7EC06412080018001\r7E906412000018001\r7EB06412080018000\r7EA06412080018000",
    "pid": "0120",
  },
  {
    "code": "7E80441210000\r7EC0441210000\r7EB0441210000\r7EA0441210000",
    "pid": "0121",
  },
  {"code": "7E8044123002F", "pid": "0123"},
  {"code": "7E803412C00", "pid": "012C"},
  {"code": "7E803412D80", "pid": "012D"},
  {"code": "7E803412E00", "pid": "012E"},
  {"code": "7E803412F7A", "pid": "012F"},
  {
    "code": "7EC03413078\r7E9034130FF\r7E8034130FF\r7EB034130FF\r7EA034130FF",
    "pid": "0130",
  },
  {
    "code":
        "7E9044131C1DB\r7E8044131BF8A\r7EC044131FFFF\r7EA044131C419\r7EB044131C419",
    "pid": "0131",
  },
  {"code": "7E8044132012C", "pid": "0132"},
  {"code": "7E803413364", "pid": "0133"},
  {"code": "7E806413481408003", "pid": "0134"},
  {"code": "7E804413C021F", "pid": "013C"},
  {
    "code": "7E906414080000000\r7E8064140FED08C05\r7EC06414000000021",
    "pid": "0140",
  },
  {"code": "7E906414100040000\r7E80641410007E5E5", "pid": "0141"},
  {"code": "7E804414235B6", "pid": "0142"},
  {"code": "7E80441430000", "pid": "0143"},
  {"code": "7E80441448000", "pid": "0144"},
  {"code": "7E803414506", "pid": "0145"},
  {"code": "7E80341463A", "pid": "0146"},
  {"code": "7E803414720", "pid": "0147"},
  {"code": "7E803414926", "pid": "0149"},
  {"code": "7E803414A27", "pid": "014A"},
  {"code": "7E803414C06", "pid": "014C"},
  {"code": "7E803415101", "pid": "0151"},
  {"code": "7E803415580", "pid": "0155"},
  {"code": "7E803415680", "pid": "0156"},
  {"code": "7EC06416000000001\r7E806416061200001", "pid": "0160"},
  {"code": "7E80341627D", "pid": "0162"},
  {"code": "7E8044163012C", "pid": "0163"},
  {"code": "NO DATA", "pid": "0167"},
  {"code": "7E807416B0149000000", "pid": "016B"},
  {"code": "7EC06418000000040\r7E80641800004000D", "pid": "0180"},
  {"code": "7E803418E7D", "pid": "018E"},
  {"code": "7E806419D00000000", "pid": "019D"},
  {"code": "7E804419E0000", "pid": "019E"},
  {"code": "7E80641A004000000", "pid": "01A0"},
  {"code": "7E80641A6001080B9", "pid": "01A6"},
];

Future<void> preloadSampleObdDataIfNeeded() async {
  final prefs = await SharedPreferences.getInstance();
  final existing = prefs.getString('last_obd_data');

  if (existing == null) {
    final Map<String, String> parsedMap = {
      for (final entry in rawObdSample)
        entry['pid'].toString().replaceFirst('01', ''):
            entry['code'].toString(),
    };

    await prefs.setString('last_obd_data', jsonEncode(parsedMap));
    print('📦 샘플 OBD 데이터 저장 완료 (${parsedMap.length}개)');
  }
}

String? extractSampleDistanceHex() {
  final entry = rawObdSample.firstWhere(
    (e) => e['pid'] == '011F',
    orElse: () => {},
  );

  if (entry.isEmpty || entry['code'] == null) return null;

  // 다중 응답 중 첫 번째 라인만 사용 (예: "7E904411F0227\n7E804411F0227")
  final code = entry['code'].toString().split('\n').first.trim();

  // 예시: "7E904411F0227" → 마지막 4자리만 사용
  final hex = code.substring(code.length - 4);
  return hex;
}

int? parseDistanceFromSample() {
  final hex = extractSampleDistanceHex();
  if (hex == null) return null;

  try {
    return int.parse(hex, radix: 16);
  } catch (e) {
    print("❌ 주행거리 파싱 실패: $e");
    return null;
  }
}

int? parseDistanceSinceDtcCleared() {
  final entry = rawObdSample.firstWhere(
    (e) => e['pid'] == '0131',
    orElse: () => {},
  );

  if (entry.isEmpty || entry['code'] == null) return null;

  final codeLine = entry['code'].toString().split('\n').first.trim();

  // 예: "7E904413135B4" → 마지막 4자리인 "35B4" (== 13748km)
  final hex = codeLine.substring(codeLine.length - 4);

  try {
    return int.parse(hex, radix: 16); // 0x35B4 = 13748
  } catch (e) {
    print("❌ DTC 삭제 후 주행거리 파싱 실패: $e");
    return null;
  }
}
